name: Publish Terraform module on Terraform Cloud

on:
  workflow_call:
    inputs:
      ENABLE_CREATE_MODULE_FOLDER:
        required: false
        type: string
        default: false
      WORKING_DIRECTORY:
        required: true
        type: string
      # workding-directory is added to specify terraform module direcotry in project source
      MODULE_NAME:
        required: true
        type: string
      PROVIDER:
        required: false
        type: string
        default: "aws"
    secrets:
      TF_ORGANIZATION:
        description: 'Terraform Organization'
        required: true
      TERRAFORM_REGISTRY_TOKEN:
        description: 'Terraform Registry Token'
        required: true

defaults:
  run:
    shell: bash

jobs:
  publish-tf-module:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Create Module Folder
        working-directory: ${{ inputs.WORKING_DIRECTORY }}
        id: create_module
        #if: {{ inputs.ENABLE_CREATE_MODULE_FOLDER == 'true'}}
        uses: wei/curl@v1
        with:
          #-d '{ "data": { "type": "registry-modules", "attributes": { "name": "ec2-keypair", "provider": "aws", "registry-name": "private",  "no-code": true } } }'
          args: |
            -X POST "https://app.terraform.io/api/v2/organizations/jingood2/registry-modules"
            -H "Content-Type: application/vnd.api+json"
            -H "Authorization: Bearer zlHNd7bqcMSPmw.atlasv1.eMvzA0znxk0Q0yY177OCyZsoDoUAyeBoIbIYUMfUJ4fv6Y2xOyCFuITiqosgtE79zHA"
            -d @module.json